import pandas as pd

from topic_extraction.link_from_id import get_scopus_link


def select_by_max_confidence(df: pd.DataFrame, k: int, min_prob: float, max_prob: float, excludes: list[str]) -> pd.DataFrame:
    df = df[~df.index.isin(excludes)]
    df = df[(df["themes_prob"] < max_prob) & (df["themes_prob"] >= min_prob)]
    sample = df.sample(k, random_state=777)
    return sample


TARGET_FILE = "plots/results/shared_results/title_abstract_keywords/all_results_tak.ods"
EXCLUDE_LIST: list[str] = ['77952584455', '78651371565', '84894425782', '84907248792', '85014165304', '85039927544', '85042946124', '85048708296', '85052146033', '85058443182',
                           '85062300747', '85063636838', '85064140418', '85066762273', '85073254862', '85074143887', '85075086981', '85076246496', '85079779229', '85081716065',
                           '85082548958', '85101505207', '85102277958', '85107357991', '85108533981', '85114906817', '85116906475', '85118130989', '85118477263', '85119086142',
                           '85119907426', '85122157457', '85123027606', '85125844292', '85125962168', '85135377323', '85135950033', '85136483534', '85140624363', '85143514408',
                           '85145885958', '85146052920', '85110708111', '85114828990', '85117258924', '85119008457', '85120953994', '85135409148', '85140895136', '85146762233',
                           '65349150180', '84901008993', '84912099899', '84923044708', '84960371712', '84965053111', '84981313721', '85010877104', '85016488184', '85017415944',
                           '85039860263', '85042202018', '85042546503', '85053497266', '85062668519', '85067673814', '85080088915', '85081233737', '85082567639', '85087686981',
                           '85088830870', '85091181787', '85096645465', '85097933111', '85099198196', '85104940493', '85106555973', '85108114044', '85111490465', '85114072976',
                           '85116455818', '85119582954', '85121792145', '85126850423', '85127390474', '85130547950', '85132793078', '85133908582', '85136530833', '85137883357',
                           '85139332726', '85145599760', '85146507978', '85147493072', '85147936237', '85041519955', '85047481248', '85062156725', '85072576674', '85107753064']
EXCLUDE_LIST += ['85147412525', '85139910222', '85132285640', '85133459108', '85131347722', '85120406970', '85100997792', '85074162493', '85074398063', '85054261475',
                 '85030749889', '85043590608', '85038637535', '85030468164', '85119652020', '85120786316', '85101084432', '85096444313', '85070896886', '85087158749',
                 '85042455591', '84857671100', '79957520956']

if __name__ == "__main__":
    dfa: pd.DataFrame = pd.read_excel(TARGET_FILE, sheet_name="classification", index_col="index", usecols=["index", "themes", "themes_prob"],
                                      dtype={"index": str, "themes": int, "themes_prob": float})

    sample_a = select_by_max_confidence(dfa, k=70, min_prob=0.8, max_prob=1.0, excludes=EXCLUDE_LIST)
    sample_b = select_by_max_confidence(dfa, k=30, min_prob=0.5, max_prob=0.8, excludes=EXCLUDE_LIST)

    full_sample = pd.concat([sample_a, sample_b])
    full_sample = full_sample.sample(frac=1.0)  # shuffle
    full_sample["link"] = [get_scopus_link(s_id) for s_id in full_sample.index.tolist()]

    full_sample.to_excel(f"plots/extraction_sample_100.ods", columns=["link"], index=True)
